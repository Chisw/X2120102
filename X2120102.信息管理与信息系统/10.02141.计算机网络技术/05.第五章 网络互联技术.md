# 第五章 网络互联技术

## 第一节 网络互联概述

网络互联技术是所有能在物理上和逻辑上实现不同网络相互连接的技术的总称，对应于 ISO/OSI 模型的各个层次

- 互连：物理连接
- 互联：功能和应用

### 一、异构网络

采用不同通信技术和运行协议的网络

实现异构网络互联的基本策略：

- 协议转换
- 构建虛拟互联网络

Internet 是利用 IP 网络实现的全球最大的互联网络：

- 是典型的在网络层实现的网络互联
- 采用同构的网络层协议 —— IP 地址与网络标识 ——— IP 地址，引入网络互联设备 —— IP 路由器

### 二、同构网络互联

两个异地以太网的互联：隧道技术

## 第二节 网际协议 IP

### 一、IP 概述

Internet 也被称为 IP 网络

IP 功能对应于 ISO/OSI 参考模型中的网络层

与之配套的还有 3 个协议，它们共同构成 TCP/IP 参考模型的网络互联层：

1. 地址解析协议 ARP
2. 网际控制报文协议 ICMP
3. 网际组管理协议 IGMP

IP 采用路由器（Router）作为网络互联的中间设备，将不同的计算机网络连接在一起，在网络层实现数据的路由和转发

路由：收集、计算和维护到达不同网络的路径信息（转发表）

#### 1. IP 是面向无连接的、不可靠的分组传输协议

IP 在发送 IP 分组时，不需要维护任何状态信息

只是简单地将分组独立地发送出去

也没有端到端的确认回传和拥塞控制机制

对发送的数据分组不保证其不丢失和按顺序到达

目的：简化分组传输，提高通信效率，可靠性可由上层协议保障，如 TCP

#### 2. IP 屏蔽数据链路层和物理层的差异，使数据的传输和转发更加方便

IP 网中，各种局域网、城域网和广域网被连接在一起

它们的物理层和数据链路层协议各不相同，存在着多种帧结构和地址设计

#### 3. IP 是点对点式网络通信协议

点对点：网络中建立通信的两台计算机之间由一条物理信道相连接

大规模计算机网络中，一般很少能够在两台计算机之间直接进行数据通信，都需要进行分组的存储转发和路由选择

### 二、IPv4 协议报文格式

```
首部
|- 固定部分
|  |- row 1
|  |  |- 版本号，4 位
|  |  |- 首部长度，4 位：最大 60 字节
|  |  |- 区分服务，8 位：只有在网络提供区分服务（DiffServ）时才使用
|  |  |- 总长度，16 位
|  |- row 2
|  |  |- 标识，16 位：累加器标识 IP 分组
|  |  |- 标志位，3 位：保留位 + 禁止分片 DF + 更多分片 MF
|  |  |- 片偏移，13 位
|  |- row 3
|  |  |- 生存时间 TTL，8 位：每转发一次减一，0 时丢弃
|  |  |- 协议，8 位：6 TCP，17 UDP
|  |  |- 首部检验和，16 位
|  |- row 4: 源 IP 地址，32 位
|  |- row 5: 目标 IP 地址，32 位
|- 可变部分
|  |- row 1
|  |  |- 选项字段，1 ~ 40B，携带安全、源路径选择、时间戳、路由记录
|  |  |- 填充，0 ~ 3B，取值全为 0，保证 32 对齐，保证首部为 4B 倍数

数据
```

## 第三节 IP 地址

为每一个参加数据通信的网络或主机分配一个在全球范围内唯一的标识符号

IP 地址的分配由因特网名称和数字分配机构 ICANN 负责

普遍使用 v4 版本，由一个 32 位二进制数表示

便于书写和阅读，用 4 个十进制数字表示，每个十进制取值 0 ~ 255，使用 . 间隔

三个历史阶段：

### 一、分类的 IP 地址

网络号 + 主机号

- A ~ E 五类
  - A: 网络号  8 + 主机号 24，  0.0.0.0 ~ 127.255.255.255
  - B: 网络号 16 + 主机号 16，128.0.0.0 ~ 191.255.255.255
  - C: 网络号 24 + 主机号  8，192.0.0.0 ~ 223.255.255.255
  - D: 最高 4 位为 1110，用于 IP 多播，224.0.0.0 ~ 239.255.255.255
  - E: 最高 4 位为 1111，作为保留使用， 240.0.0.0 ~ 255.255.255.255

网络号越短，则一个网络内可以容纳的主机数越多

特殊 IP

| NetID | HostID | 作为 IP 分组源地址 | 作为 IP 分组目的地址 | 用途 |
| -- | -- | -- | -- | -- |
全 0 | 全 0 | Y | N | 本网表示本机，路由表用于表示默认路由（相当于整个网络）
全 0 | 特定值 | N | Y | 表示本网内的某个特定主机
全 1 | 全 1 | N | Y | 本网广播地址（路由器不转发）
特定值 | 全 0 | N | N | 网络地址，表示一个网络
特定值 | 全 1 | N | Y | 直接广播地址，对特定网络上的所有主机进行广播
127 | 非全 0 或非全 1 | Y | Y | 用于本地软件环回测试，称为环回地址

管理机构只需要向申请者分配网络号，获得某一网络号的单位在自己所管辖范围内自主分配主机号

所有网络号相同的主机被视为一个网络

IP 网中的路由器在转发分组时是按照网络号进行转发的

大大减少路由表中的项目，从而节约存储空间，提高查找速度，提高网络运行的效率

弊端：IP 分配中的巨大浪费

### 二、子网划分

两级的 IP 地址结构变为三级 IP 地址结构

网络号 + 子网号 + 主机号

一个拥有多个物理网络的单位，可以利用子网号，将自己所管辖的物理网络划分为若干个子网（Subnet）

划分子网是单位内部的行为，与 IP 地址管理机构无关，外部网络也看不到这个单位内部划分了多少个子网，仍然将这个单位视为一个网络

从其他网络发送给某单位中某个主机的 IP 数据报，先根据其目的 IP 地址中的网络号找到单位网络相连接的路由器

该路由器再根据目的 IP 地址中的子网号找到相应的子网，最终将 IP 数据报发送到目的主机

每个子网可以容纳的最大主机数为 2^5-2=30 个

划分子网后，整个网络对外仍表现为一个网络

子网划分方法的一个最核心问题：如何使得网络连接的路由器能够正确地将 IP 数据报发送给网络内部不同的子网

实际应用中采用的是一种被称为 “子网掩码”（Subnet Mask）的方法

子网掩码从形式上看是一个32 位的二进制数，也可以用 4 个点分十进制数来表示

某个网络的路由器在收到一个 IP 数据报后，首先要将数据报的目的 IP 地址与路由器所连接网络的子网掩码逐位进行“逻辑与 AND〞运算，得出子网网络地址

如果内部网络没有进行子网划分，则采用默认的子网掩码（即子网掩码中1的位置与 IP 地址网络号字段相对应）

- A: 255.0.0.0
- B: 255.255.0.0
- C: 255.255.255.0

子网掩码成为 Internet 正式标准后，Internet 中的路由器在与相邻路由器交换路由信息时，必领把自己所在网络或子网的子网掩码告诉相邻路由器

路由器的路由表中也必领包含目的网络的子网掩码

### 三、无分类编址 CIDR

无分类域间路由选择：在变长子网掩码 VLSM 的基础上研究出

IPv4 的地址空间已经基本耗尽

CIDR 不再按照 A、B、C类的类型区分 IP 地址，也不再使用子网号字段

网络前缀 + 主机号

在 IP 地址后面加上斜线 加 网络前缀位数 的方式来标注一个完整的 IP 地址

```
202.194.20.138/27

前 27 位为网络前缀，后 5 位为主机号
```

网络前缀都相同的连续 IP 地址称为一个 CIDR 地址块

其中一个地址被确定，则整个地址块的最小地址、最大地址、地址数就都可以被确定

为了和现有的使用子网掩码的网络兼容，CIDR 的斜线加网络前缀表示法也可以表示成子网掩码的形式

CIDR 的一个重要作用就是用来简化路由器中的路由表

将众多的 IP 地址聚合在一个 CIDR 地址块中，减少信息交换，提高网络性能

这种方式称为“路由聚合”，也称“构成超网”

### 保留地址

私有地址或专用地址，网络内部使用，无法在公网上使用

- A: 10.0.0.0 ~ 10.255.255.255 (10.0.0.0/8)
- B: 172.16.0.0 ~ 172.31.255.255 (172.16.0.0/12)
- C: 192.168.0.0 ~ 192.168.255.255 (192.168.0.0/16)

使用私有地址的主机可以方便地与网络内的其他主机进行通信

如果需要与网络外的其他主机通信，必须采用一定的机制进行地址转换

实际网络中使用的私用地址转换方法：网络地址转换协议 (Network Address Translation, NAT)

NAT 路由器内部维护地址转换表

## 第四节 IP 路由概述

在整个网络中为 IP 数据报寻找合适的通信路径

并且将其转发出去的过程称为 IP 路由，是由路由器实现的

### 一、路由器的结构及功能

路由器是一种具有多个输入端口、多个输出端口的专用计算机

主要任务：获取与维护路由信息及转发分组

构成：

- 输入端口
  - 从物理接口接收信号，还原数据帧，提取 IP 数据报
  - 根据路由表获取输出端口，交给交换结构
  - 需要有缓存，保存排队的 IP 数据报
  - 输入快于交换时，缓存溢出，数据宝丢弃，拥塞
- 输出端口
  - 也需要缓存，保存排队交换到指定端口待发送的 IP 数据报
  - 调度策略：先到先服务、优先级、数据报 TOS 类型
- 交换结构
  - 基于内存交换：性能低，便宜
  - 基于总线交换
  - 基于高级的交叉网络交换：性能高，昂贵
  - 其性能很大程度决定了路由器性能
- 路由处理器
  - 执行各种指令（路由协议运行、路由计算、路由表维护）

### 二、路由表与路由转发

获取路由信息保存在路由表，供数据转发时使用

- 静态：人工
- 动态：运行路由协议

路由表是以路由项来存储路由信息的，每个路由项也称为一个“入口”（Entry）

路由表基本结构：

- 目的网络
- 子网掩码
- 下一跳：到达该目的网络的路径的下一个邻居结点的接口 IP 地址
- 接口

路由器在收到 IP 数据报时，会利用 IP 数据报的目的 IP 地址检索匹配路由表

没有匹配成功则通过默认路由对应的接口转发该 IP 数据报

所以，至少会有默认路由会被匹配“成功”

如果只匹配到一条，顺利转发

如果匹配到两条及以上，则选择网络前级匹配成功位数最长的路由项（最长前缀匹配原则）

### 三、路由算法

1. 静态路由与动态路由
  - 静态优先级高
  - 动态周期性更新

2. 距离-向量路由算法
  - 仅需网络“局部”信息、异步的、迭代的、分散式的路由算法
  - Bellman-Ford 方程
  - 每个路由器周期性地向邻居通告形如＜目的网络，距离＞的距离向量
  - 消减无穷计数问题：毒性逆转、定义最大有效距离（RIP 15 跳）、水平分割、阻碍时钟

3. 链路状态路由算法
  - 抽象为图，然后用 Dijkstra 算法求最短路径
  - 网络存在环路且链路费用反映动态的链路通信量时，振荡、摆动，Ping-Pang 转发，最终丢弃

4. 层次路由
  - 当网络规模很大时，基于单一抽象网络拓扑图的路由算法不再适用
  - 交换信息带宽消耗大，无法满足自治
  - 将大规模的互联网按组织边界、管理边界、网络技术边界或功能边界划分为多个自治系统（AS）
  - 每个自治系统由一组运行相同路由协议的路由器组成
  - 每个自治系统存在一个或多个与其他自治系统互连的路由器，称为网关路由器

### 四、路由协议

1. 自治系统 AS
  - 在统一技术管理下的一组路由器
  - 使用相同的 AS 内部路由选择协议和度量以确定分组在该 AS 内的路由

2. 域内路由与域间路由
  - Internet 域内路由协议：内部网关协议 IGP
  - Internet 域间路由协议：外部网关协议 EGP，使用最多的是 BGP4

3. RIP 路由协议
  - 一种分布式的基于距离向量的 ICP
  - 要求自治系统内的每一个路由器都要维护从它自己到其他每一个目的网络的距离向量
  - “距离”也称为 “跳数” Hop Count

4. OSPF 路由协议
  - 是开放最短路径优先协议
  - 非商业、最短路径优先、IGP

5. BGP 协议
  - 是不同自治系统的路由器之间交换路由信息的协议
  - 边界网关协议BCP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由
  - 支持 CIDR
  - 包括 4 中类型报文：
    - OPEN: 与相邻的另一个BGP 发言人建立关系
    - UPDATE: 发送某一路由的信息，以及列出要撤销的当条路由
    - KEEPALIVE: 确认打开报文和周期性地证实邻站关系
    - NOTIFICATION: 发送检测到的差错

## 第五节 IP 中的其他重要协议

### 一、地址解析协议 ARP

网络中的主机在发送数据时，数据从应用层开始，由上而下，一层层地被封装

直到交给数据链路层，被封装成 MAC 帧，再交给物理层进行传输

而 MAC 帧中使用的源地址和目的地址都是硬件地址（如局域网的以太网地址）

而 IP 地址则被隐藏在 MAC 帧的数据中，数据链路层看不到 IP 地址

当 Internet 上的应用使用 IP 地址进行通信时，发送数据的主机和转发数据的路由器都必须要知道 IP 地址所对应的硬件地址才能将通信过程具体实现

地址解析协议 ARP 就是用来解决这—问题的一套机制

#### 基本思想

在每一台主机中设置专用内存区域，称为 ARP 高速缓存

里面有该主机所在局域网中各个主机和路由器的 IP 地址与硬件地址的映射表，并要经常更新

为了防止局域网中主机硬件地址的变更，ARP 高速缓存中的每一对地址映射都有一个生存时间（几十分钟），如果超过生存时间，该地址映射将被从高速缓存中删除

删除后需要重新运行 ARP 查找主机的硬件地址

不同局域网的主机之间发送 IP 数据报时，需要在主机和路由器上多次使用 ARP 进行 IP 地址与硬件地址的映射解析

### 二、动态主机配置协议 DHCP

联网需要配置：分配的 IP 地址、子网掩码、默认路由器的 IP 地址和域名服务器的 IP 地址等

采用的是客户机/服务器模式：

- 在一个网络内部设置一台 DHCP 服务器（或者多个网络共用一台 DHCP 服务器，每个网络通过 DHCP 中继代理与服务器相连)
- 其中保存和管理着该网络所管辖的 IP地址及其他配置信息
- 当一台计算机新接入该网络时，还没有配置 IP 地址，它在开机启动后向该网络广播发送一个 DHCP 发现报文（DHCPDISCOVER)，其目的 IP 地址置为全 1，源 IP 地址置为全 0
- DHCP 服务器在收到这个 DHCP 发现报文后，从自己所保存的 IP 地址数据库中取出一个，与其他配置信息一起，通过 DHCP 提供报文 （DHCPOFFER) 发送给这台计算机，从而为这台计算机分配一个新的 IP 址及其他配置信息，则这台计算机就可以使用这个 IP 地址及其他配置信息访问 Internet

DHCP 服务器分配给网络中计算机的 IP 地址是临时的，只能在一段时间内有效，这个时间称为租用期

租用期的具体时间由 DHCP 服务器自行决定，也可以由 DHCP 客户端在发现报文中提出对租用期的要求

Windows 操作：

- 桌面/网络/属性/更改适配器设置/本地连接/属性/Internet协议版本4 (TCP/IPv4)
- 自动获得 IP 地址
- 自动获得 DNS 服务器

### 三、网际控制报文协议 ICMP

传输中的延迟、丢失等异常报告给通信双方的机制

让主机、路由器发送 ICMP 报文

格式：

- 类型：1B
- 代码：1B
- 检验和：2B
- 内容取决于类型：4B
- ICMP 数据部分：长度取决于类型

类型：

1. 差错报告
  - 终点不可达，类型值 3：不能交付数据
  - 源点抑制，类型值 4：拥塞丢弃数据，降低发送率
  - 时间超时，类型值 11
  - 参数问题，类型值 12：字段值不正确
  - 改变路由，类型值 5

2. 询问报文
  - 回送请求（8）和回答（0）
  - 时间戳请求（13）和回答（14）：时间同步、测量时间

### 三、网际组管理协议 IGMP

是 IP 的一部分，对 IP 多播（Multicast）提供管理服务

多播：一个源点向多个终点发送数据，大大节省网络资源，需要多播路由器支持

多播地址只能用于目的地址，不能用于源地址

工作过程：

1. 主机加入多播组时，发送 IGMP 报文，表明想要加入，多播路由器收到后根据协议通知 Internet 上其它多播路由器
2. 各局域网多播路由器定期探寻本地主机，确定是否为多播成员，探寻到则认为该组活跃，否则不再发送成员组信息

## 第六节 IPv6 协议

v4 资源严重不足

1992 IETF IPng 工作组 IPv6

格式：

```
基本首部
|- 版本号 4 位
|- 通信业务类型 8 位
|- 流标号 20 位

|- 有效载荷长度 16 位
|- 下一个首部 8 位
|- 跳数限制 8 位

|- 源地址 128 位

|- 目的地址位 128 位

扩展首部
...
扩展首部 N
数据报部分
```

IPv6 与 IPv4 相比基本首部去掉了选项字段、校验和字段等，增加了流标签字段，基本首部变得更简洁，有利于快速路由

IPv6 中将 IP 地址设置为 128 位，最多可以提供多达 3.4 × 10^38

采用冒号分隔的十六进制地址书写形式，把每 16 位的值用十六进制数表示，各个数之间用冒号隔开

双冒号隔开连续多部分 0

类型：

- 单播地址：唯一标识网络中的一个主机或路由器网络接口
- 组播地址：标识网络中的一组主机，只能用作目的地址，每个成员接收
- 任播地址：同上，但单个成员接收

我国 下一代互联网规范工程 CNGI 取得一系列成果

2003 第二代中国教育和科研计算机网 CERNET2 建成，世界规模最大 IPv6

## 思考与练习

1. 清解释 “网络互联”和“网络互连”的不同含义
2. 请简述 IP 的特点。
3. TCP/IP 参考模型的网络互联层由哪些协议组成？
4. 请简述 IPv4 协议报文中生存时间（TTL）字段的作用。
5. 请辨别以下 IP 地址的类别。
```
128.60.222.18
202.194.20.138
20.194.32.54
88.88.88.88
198.12.87.252
```
6. 有两个 CIDR 地址块 208. 128.0.0/11 和208. 130.28.0/22。请问是否有一个地址块包含了另一个地址？请说明理由。
7. 已知地址块中的一个地址是 140.120.84.24/20，请问支持该地址块中的最小地址和最大地址，共有多少个地址？
8. 某单位分配到一个地址块 136.23.12.64/26，现在需要进一步划分为 4 个一样大的子网，则每个子网的网络前缀有多长，每个子网中有多少个 IP 地址，每个子网的地址块是什么？
9. 请简述 RIP、OSPF 和 BGP 路由协议的特点。
10. 请简述 ARP 的基本工作过程。
11. 请简述在 Windows 操作系统下，将本地计算机设置为使用 DHCP 自动分配 IP 地址的操作过程。
12. 请简述最长前缀匹配原则的基本原理。
13. 链路状态路由算法使用什么算法求出最短路径？
14. ICMP 报文有哪两种类型？每种类型报文各有哪些情况？
15. 请简述 ICMP 的工作过程。
16. 请对 IPv6 地址 AC62:0000:0000:0000:0000:73FA:0000:0000 进行化简。
