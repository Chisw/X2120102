# 第四章 局域网技术

## 第一节 局域网概述

### 一、概述

是计算机网络的一种具体应用形式，互联网的重要组成部分，文件管理、应用软件共享

1970s
- 美国加州大学 Newhall 环网
- 英国剑桥大学 Cambridge Ring 环网
- IBM 令牌环网
- 通用汽车公司 令牌总线网等
- 1975 年美国施乐公司基于总线的局域网产品 以太网（Ethemet)
- DEC、Intel 和施乐公司联合提出了以太网规约的第一个版本 DIX V1 - 1982 年 DIX v2

1980s，局域网广泛应用，主导地位的有：以太网、令牌环网和令牌总线

决局域网技术标准化：美国电气和电子工程师协会 IEEE 在1980 年成立局域网标准委员会，简称 IEEE 802 委员会

### 二、IEEE 802

IEEE 802 标准主要研究局域网内部数据传输与控制，无须考虑路由和交换，对应 OSI 参考模型的数据链路层和物理层

为将多种局域网技术纳入统一协议模型，委员会提出将数据链路层划分为两个子层：

1. 逻辑链路控制子层 Logical Link Control, LLC
- 与接入传输介质有关的内容都放在 MAC 子层，包括将上层数据封裝成帧进行发送、寻址和比特差错检测等

2. 介质访问控制子层 Media Access Control, MAC
- LLC 层负责与介质接入无关的内容，包括建立和释放数据链路层的逻辑连接、提供帧序号、提供高层接口和差错控制等

- 不同局域网产品在 MAC 子层和物理层可以采用不同的技术和协议，但在 LLC 子层必须采用相同的技术和协议
- 不管局域网采用什么物理传输介质、介质访问方法及 MAC 帧结构，LLC 子层统将它们封装到相同格式的 LLC 帧中
- 网络层就可以不考虑局域网的传输介质、拓扑结构和介质访问方法等，只需处理格式统一的 LLC 帧

IEEE 802 系列标准：

- 802.3 以太网 脱颖而出
- 802.4 令牌总线网
- 802.5 令牌环网
- ...

## 第二节 以太网技术 Ethernet

### 一、以太网基本原理

目前应用最为普遍的局域网

技术规范包括：

- 拓扑结构
- 传输介质
- 介质访问方式
- 传输速率
- 最多工作站数
- 最远传输距离

介质共享型局域网中的介质访问控制（MAC）协议解决三个问题：

1. 在某一时刻，哪个结点可以发送数据
2. 发送时是否会出现冲突
3. 出现冲突如何处理

#### 载波监听多路访问/冲突检测（CSMA/CD）

以太网中采用 CSMA/CD 作为介质控制访问方法：先监听、再发送；边监听，边发送

发送前检测总线是否空闲

由于采用曼彻斯特编码，检测的是电平高低变化（载波监听）

检测时因电磁波有限的速率，尚未检测到时发送数据后继续检测，信号电压叠加增加会导致电压变化幅度超过某一阈值，即冲突

发生冲突时停止发送数据，以免浪费网络资源，稍后发送

### 二、以太网的硬件地址

IEEE 802 委员会为局域网设定了一套标识规则：用一个 48bit（6B）二进制数作为局域网的全球地址

标识每一块局域网适配器（网卡），在适配器生产时就固化在其 ROM 中，称为物理地址或 MAC 地址

IEEE 注册管理机构 RA 负责分配前 3 个字节，厂商负责后 3 个

### 三、以太网的 MAC 帧格式

在以太网的 MAC 层，数据是以帧（frame）形式存在的

#### 两种帧标准

1. DIX Ethernet V2 (以太网v2)
  - 设有两个类型字节，标识上一层协议类型

2. IEEE 802.3
  - 长度/类型，字段值分隔点 0x0600

#### 帧结构

1. 目的地址 6B
2. 源地址 6B
3. 长度/类型 2B
4. 数据 46~1500B (不足 46B 填充)
5. FCS 帧检测序列 4B （循环冗余 CRC 校验）

- 实际传输中，发送端要在每个以太网 MAC 帧前面插入 8B（由硬件生成）
- 包括 7B 的前导码和 1B 的帧前定界符，用于告知数据已接收

#### 共享式以太网的基本工作原理

1. A -> B
2. 封装两点 MAC 地址及数据，开始监听以太网
3. 网络空闲时，将帧以广播的形式发送，并监听是否发生碰撞
4. B 监听到目的地址与自己的地址一致时，检测是否无效帧，是则丢弃，否则接收
5. 出现无效帧的情况：
  - 长度非整数字节
  - FCS 出错
  - 长度不在 64~1518B 之间
6. 以太网不对丢弃的帧负责重传，由高层协议决定

### 四、以太网的产品类型

1. 粗缆以太网 10Base-5
  - 最早的以太网产品，50Ω 粗同轴电缆
  - 以太网中的每一个站点通过收发器和收发器电缆与干线相连
  - 10: 10Mbit/s
  - Base: 基带信号
  - 5: 每段线缆最大长度 500m，超过时需要中继器（Repeater）放大信号并整形转发
  - 工作站到收发器最大距离为 50m
  - 最多使用 4 个中继器连接 5 条干线
  - 最大网络干线长度 2469m
  - 一条干线最多支持 100 个工作站，中继器也相当于一个工作站
  - 目前已不再使用

2. 细缆以太网 10Base-2
  - 0.2in 50Ω 同轴电缆
  - 采用网卡和 T 形连接器
  - 组网开销低，连接方便
  - 最多使用 4 个中继器连接 5 条干线
  - 最大网络干线长度 910m
  - 一条干线最多 30 个工作站，中继器也相当于一个工作站
  - 目前已不再使用

3. 双绞线以太网 10Base-T
  - 采用非屏蔽双绞线 UTP 作为传输介质
  - 支持以太网结构化布线方式和集线器 Hub 设备
  - 支持不超过 100m 的 UTP 连接到一个集线器上
  - 多个集线器可以通过级联方式连接到其他集线器上
  - 组网容易且方便，具有良好的故障隔离功能
  - 工作站、集线器、双绞线之间的物理接口采用标准的 RJ-45 接口
  - 最低标准是 3 类 UTP，特征阻抗为 100Ω
  - 最多支持 4 个集线器或中继器，从而构成 5 个网段

4. 快速以太网 100Base-T (IEEE802.3u)
  - 提升至 100Mbit/s
  - 100Base-TX 两对 5 类 UTP
  - 100Base-T4 四对 3/4/5 类 UTP
  - 100Base-FX 光缆

5. 千兆位以太网 Gigabit Ethernet
  - 提升至 1000Mbit/s，与传统兼容
  - 1000Base-SX
  - 1000Base-LX
  - 1000Base-CX
  - 1000Base-T

6. 万兆位以太网 10Gigabit Ethernet (IEEE 802.3ae)
  - MAC 层帧结构与千兆位保持一致，但不再支持 CSMA/CD 介质控制方式
  - 保留 802.3 标准的最小、最大帧长度
  - 只支持全双工传输方式
  - 提供 5 种物理接口，支持单模、多模光纤
  - 提供更高带宽和更远传输距离的通信服务

### 五、以太网的扩展

分为物理层扩展、数据链路层扩展

1. 中继器和集线器（物理层）
  - 于以太网中的数字基带信号在传输介质中传输会产生衰减
  - 对信号的放大和转发或重发，不关心具体内容
  - 集线器是一种特殊的中继器（级联作用），容易产生碰撞

2. 网桥 Bridge（数据链路层）
  - 网络规模更大、结构更复杂时，物理层效率过低
  - 工作在数据链路层的以太网扩展设备
  - 通常连接较少网段，否则会因信息过多产生广播风暴
  - 内部维护的**转发表**对 MAC 地址进行记录并对帧进行分配
  - 网桥机制可以保证不同网段通信互不干扰

3. 以太网交换机 Switch（数据链路层）
  - 又称为第二层交换机
  - 实质：多接口网桥（几十个接口以上）
  - 其每一个接口都与主机或者集线器相连
  - 网桥的接口通常连接在以太网的总线上
  - 交换机内部采用专用的交换结构芯片，大大提升交换速度
  - 没有检测到转发表项时，向除接收该帧端口以外所有端口泛洪该帧（每个端口都发送一份副本）
  - 交换方式：
    - 直接交换 cut-through: 接收到帧后直接查表转发，由目的主机进行差错校验，加快交换速度
    - 存储转发交换 store and forward: 暂存并校验，无差错再转发，避免信道资源浪费
  - 交换式以太网相比分享式以太网优点：
    - 保留现有设施基础，无须丢弃或重建
    - 允许多主机同时通信，实现无碰撞数据传输
    - 可以连接不同速率的以太网
    - 实现帧过滤、传输控制和虚拟局域网设置等
  - 种类：
    - 单台交换机
    - 堆叠交换机
    - 箱体模块化交换机

## 第三节 虚拟局域网 VLAN

### 一、虚拟局域网的基本概念

是一种基于交换机的局域网应用形式

IEEE 802.1Q: VLAN 是由一些局域网段构成的、与物理位置无关的逻辑组，而这些王阔具有某些共同的需求

每一个 VLAN 帧都有一个明确的标识符，可以指明发送这个帧的主机属于哪一个 VLAN

### 二、虚拟局域网的划分方法（软件）

1. 基于交换机端口的划分
  - 静态虚拟局域网

2. 基于 MAC 地址的划分
  - 新增或移动用户时，自动划分、减少配线、布局环节

3. 基于上层协议类型或地址的划分
  - 有利于组成基于应用的 VLAN

### 三、虚拟局域网的帧格式

对以太网帧格式进行扩展，标识以太网帧所属的不同虚拟局域网

在**源地址**和**类型**中间插入一个 4B 大小的标识 VLAN Tag

1. 前 2B 固定 0x8100 (IEEE 802.1Q 标记类型)

2. 后 2B
  - 3 位是用户优先级字段 
  - 1 位用户优先级字段 CFI
  - 12 位 VLAN 标识符（VID）：标明该以太网帧属于哪个 VLAN

### 四、虚拟局域网中继技术 VLAN Trunk

VLAN 按逻辑位置而非物理位置划分

交换机与交换机之间通过 Trunk 接口连接

### 五、交换机配置 VLAN 的基本命令

1. 创建和修改

```sh
switch >

switch > enable
switch#

switch#configure terminal
switch(config)# vlan vlan-id
# vlan-id: 1~4094
```

2. 删除

```sh
switch(config)# no vlan vlan-id
```

3. 指定端口

端口有两种类型
  - Access: 只能属于一个 VLAN, 手工指定，不能直接与另一个 VLAN 收发消息
  - Trunk: 默认属于交换机所有 VLAN，能够收发所有数据

```sh
interface port-id
switchport access vlan vlan-id

interface port-id
switchport mode trunk
switchport trunk allowed vlan | all | [add | remove | except] | vlan-list
```

4. 将端口从 VLAN 中移出

```sh
interface port-id
no switchport access vlan

interface port-id
switchport trunk allowed vlan remove vlan-id
```

5. 显示 VLAN 信息

```sh
show vlan [id vlan-id]

# 显示全部
switch#show vlan

# 显示某个 id: 1~4094
switch#show vlan id
```

## 第四节 无线局域网 WLAN

按结构划分

1. 有固定基础设施局域网：存在有线连接
2. 无固定基础设施局域网：都是可移动设备

### 一、有固定基础设施局域网

星形拓扑结构，通过无线方式与 Access Point 相连

IEEE 802.11 在 MAC 层使用载波监听多路访问/冲突避免协议 CSMA/CA

使用 IEEE 802.11 协议的无线也称为 Wi-Fi

与 CSMA/CD 协议不同，原因：

- 无线环境，信号强度动态范围大，不易通过强度检测是否发生碰撞
- 电磁波向所有方向传播，检测不准确

避免碰撞：

1. “停止-等待”可靠传输，确认后才继续发送
2. 虚拟载波监听，发送方将占用的信道告诉所有站点
3. 信道忙态转换为闲态时，各站点执行“退避算法”，等待一个随机时间段后再发送数据

规定 WLAN 的最小单位为基本服务集 BSS：一个 AP 和多个移动设备

BSS 内设备可以互相通信，之外必须经过 AP

每个 BSS 需要被设置一个不超过 32B 的服务集标识符 SSID

覆盖范围不超过 100m，多个 BSS 通过 DS 组成更大范围的 ESS

移动设备与和本 BSS 内的 AP 建立关联有两种方式：

1. 被动扫描：周期发送 SSID、速率等信息
2. 主动扫描：移动设备主动发送探测请求

### 二、无固定基础设施局域网

- 自组网络 Ad Hoc
- 设备既收发也转发
- 能随网络拓扑结构变化不断更新路由方案
- 一般是独立运行的，不与外界网络相连
- 运用在军事、救灾、勘探领域





