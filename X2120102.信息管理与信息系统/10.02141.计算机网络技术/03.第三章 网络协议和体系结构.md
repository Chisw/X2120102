# 第三章 网络协议和体系结构

## 第一节 网络协议和体系结构概述

### 一、网络协议的概念

从硬件来看，只要有终端、信道和交换设备，就能使两个用户建立起连接，但要实现信息交换是不够的，需要制定规定

双方必须遵守的规则和约定称为协议或规程

包括：

1. 语法：如何讲，确定数据格式、数据码型、信号电平
2. 语义：讲什么，确定协议元素的类型，发出的控制信息、执行的返回动作、返回的应答
3. 时序关系：规定执行的顺序，确定通信状态的变化、正确的应答

### 二、分层的思想

从底层信号到完整数据分组中，技术复杂、涉及广泛，很难在一个协议中全部完成

将复杂功能由若干协议分别完成，再将其按一定方式组织起来，最典型的采用**分层方式**

核心思路：上层的功能建立在下层功能基础上，每层遵守一定的通信规则

优势：

1. 各层次之间可相互独立
- 高层无须了解底层的工作机制、使用设备和技术细节，需要低层通过接口提供哪些服务
- 每层的功能、任务清晰明确，且相对独立

2. 较强灵活性，便于实现和维护
- 整体规划、设计需要考虑十分周到
- 层次划分后，被分解成若干更容易处理的部分
- 单个领域更易发展，变化后也不会影响其他层

3. 有利于标准化
- 界定后可围绕确定的功能和服务制定相应的标准

### 三、网络体系结构

层次和协议的集合构成了网络的体系结构

其研究的是网络系统各部分的组成及其相互关系

完整的体系结构应该包括整个计算机网络的逻辑组成和功能分配，定义和描述了用于计算机及其通信设施之间互联的标准和规范的集合，以便在统一的原则指导下进行计算机网络的设计、构造、使用和维护

一种体系结构应当具有足够的信息，以允许软件设计人员给每个层次编写实现该层协议的有关程序，即通信软件，

- 1960s IBM SNA Systems Network Architecture
- DEC DNA Digital Network Architecture

目前典型的层次化体系结构有 OSI、TCP/IP

## 第二节 OSI 参考模型

1984 ISO 吸取 SNA 及其他网络体系结构，提出了开放系统互连 OSI (Open System Interconnection) 参考模型 (OSI/RM)，简称 OSI 模型

所谓开放、指按照这个标准设计和建成的数据通信网中的设备都可以互相通信

### 一、OSI 参考模型各层的功能

采用分层结构化技术分为 7 层，上 4 层：结点到结点层，下 3 层：端到端层

上 4 层主要完成信息处理服务功能，称为网络高层

下 3 层主要完成数据交换和数据传输，称为网络低层，即通信子网

低层与高层之间由第 4 传输层街接

中间系统（比如路由器）通常只实现下 3 层，物理层端到端通信：实通信

```
应用层
  |
表示层
  |
会话层
  |
传输(运输)层
  |
网络层
  |
数据链路层
  |
物理层
```

1. 物理层
- 在传输介质上实现无结构比特流传输
- 不关心实际内容，只关心如何将 0、1 以合适信号传送
- 需要实现信号编码功能
- 规定数据终端设备(DTE)、通信设备(DCE)间的接口，包括机四个方面：
  - 机械：物理特性，接口的形状、尺寸、插脚、排列方式
  - 电气：电路特性，电平大小、接收器发送器电路特性、信号识别、最大传输速率
  - 功能：各信号线用途，功能分类
  - 规程：指明传输全程及事件发生的顺序、传输方式
- 典型的有：RS-232、RS-449

2. 数据链路层
- 主要是在相邻结点间传输数据
- 物理传输难免出错，为实现差错控制，采用“帧”为单位的数据块传输方式
- 需要相应的帧同步技术，数据链路层的“成帧（帧同步）”，包括
  - 定义帧的格式、类型、成帧方法
- 功能：
  - 数据吗附加循环码实现链路层差错控制
  - 实现相邻结点间的流量控制
  - 链路管理
  - **寻址**：确保每帧准确传送到正确处，接收方也应该知道发送方的地址，在广播介质网络中尤为重要，比如局域网中广泛采用 MAC 地址

3. 网络层
- 解决如何将分组通过交换网络传送至目的主机
- 主要功能是数据转发、路由
- 源结点、中继结点、目的结点构成了路径
- 结点间有多条路径可选，此路由选择是网络层的要完成主要功能之一
- 还要控制通信量，避免网络性能下降
- 与链路层类似，也具备寻址功能，确保分组正确传输，比如 IP 地址

4. 传输层
- 是第一个端到端的层次，也是进程-进程层次
- 数据通信表面是在两台主机间进行，实质上是在两个主机的进程之间
- 物理、链路、网络三层可组成公共网络，被多设备共享，且计算机-结点机、结点机-结点机是按照“接力〞方式传送
- 为了防止传送途中报文的丢失，两个主机的进程之间需要实现端到端控制
- 传输层的功能主要包括复用/解复用（区分发送和接收主机上的进程）、端到端的可靠数据传输、连接控制、流量控制和拥塞控制机制等

5. 会话层
- 指用户间连接，通过两台计算机间建立、管理和终止通信来完成对话
- 主要功能：
  - 建立会话时核实双方身份是否有权参加会话
  - 确定何方支付通信费用
  - 双方在各种选择功能方面（如全双工还是半双工通信）取得一致
  - 在会话建立以后，需要对进程问的对话进行管理与控制
- 实际中，会话层的功能已经被应用层覆盖，很少单独存在

6. 表示层
- 主要处理应用实体间交换数据的语法，解决格式和数据表示的差别
- 为应用层提供一致的数据格式，从而使字符、格式等有差异的设备之间相互通信
- 还可实现文本压缩、解压缩，数据加密、解密，字符编码转换
- 此层某些实际数据通讯网络中也是由应用层实现，不独立存在

7. 应用层
- 与提供给用户丰富的网络服务相关：文件传送、电子邮件和 P2P 应用等
- 应用层为用户提供了一个应用网络通信的接口

### 二、OSI 参考模型的有关术语

每层真正功能是为上层服务

1. 数据单元
- 层实体间传送的比特组称为数据单元
- 对等层间传输按本层协议进行，此时称为协议数据单元
- PDU 在不同层往往有不同的叫法
  - 物理层中：位流或比特流
  - 数据链路层中：帧
  - 网络层中：分组或包
  - 传输层中：数据段或报文段
  - 应用层中：报文

2. 服务访问点
- 邻层间服务通过接口面的服务访问点（SAP Service Access Point）进行
- 每个 SAP 有唯一地址号码

3. 服务原语
- 邻层间服务的提供、请求提供都是用一组原语（Primitive）描述的：
  - 请求 Request
  - 指示 Indication
  - 响应 Response
  - 确认 Confirm

4. 面向连接和无连接
- 分层体系结构中，下层向上层提供服务的两种形式
- 面向连接：电话系统，建立连接、发送数据
- 无连接（数据报 Datagram）：邮件发送，没有建立河拆除链路的过程

## 第三节 TCP/IP 参考模型

OSI 跟多是一种理论上的体系结构，实际数据通信网络中， Internet 体系的 TCP/IP 更具有现实意义

### 一、TCP/IP 的产生

阿帕网之际，不同软硬件构成的计算机通信困难

以 Vinton G. Cerf 和 Robert E. Kahn 两位为首的研修小组，1970 NCP、1974 TCP、1978 IP 抽离自 TCP，TCP 正式变为 TCP/IP

TCP 负责发现传输问题，一有问题就发出信号，要求重新传输，直到所有数据安全正确传输至目的地

IP 给每一台计算机规定一个地址，从而实现准确传输

1983.1.1 NCP 停止使用，TCP/IP 作为互联网上所有主机间的共同协议开始运行

### 二、TCP/IP 参考模型及其功能介绍

1. 应用层
- 将 OSI 中的**会话层**和**表示层**合并到**应用层**
- 用户通过应用层来使用各种服务：WWW、文件传输、电子邮件
- 各应用使用相应的协议来封装数据：HTTP、FTP、SMTP POP3
- 每层应用协议都会使用：面向连接传输控制协议 TCP 或 无连接用户数据包协议 UDP

2. 传输层
- 应用层封装后，由传输层协议负责传输
- 逻辑通信：两个进程之间的通信就像所在的两个主机存在直接连接一样，实际上，主机间可能相距很远，两者的物理连接可能经过了多个交换机/路由器，传输路径可能由不同类型的物理链路组成
- 利用逻辑通信机制，两个进程可以不用考虑两者之间的物理连接方式而实现发送/接收消息
- 传输层协议可解决端到端可靠性、保证数据按照正确的顺序到达等问题
- 传输层负责在**网络层**和**应用层**之间传递消息，不涉及消息如何在网络中传输，交由网络互联层去解决
- 主要包括面向连接、提供可靠数据流传输的传输控制协议（TCP） 和无连接、不提供可靠数据传输的用户数据报协议 (UDP)

3. 网络互联层
- 为 TCP/IP 的核心，将数据分组发往目的网络或主机
- 过程中，要为分组的传输选择相应的路径 (路由选择），完成分组转发，提供网络层寻址 IP 地址
- 网络互联层除了需要完成路由的功能外，也可以完成将不同类型的网络（异构网）互联的任务
- 网络互联层的核心协议是 IP，负责定义分组的格式和传输
- IP 是无连接不可靠网络协议，因此 IP 分组到达的顺序和发送的顺序可能不同，并且可能存在分组丢失现象
- 网络互联层还包括互联网控制报文协议(ICMP）、互联网多播组管理协议（ICMP)，以及路由协议，如BCP、OSPF 和 RIP 等

4. 网络接口层
- 实际上 TCP/IP 没有真正描述这一层的实现，只要求能够提供给其上层网络互联层一个访问接口，以便在其上传递 IP 分组
- 末被定义，所以其具体的实现方法将随着网络类型而变化
- 这一层包括 OSI 参考模型中的**数据链路层**和**物理层**，不同网络类型将上层的 IP 分组封装到数据帧中，实现有关的链路控制功能，最终以比特流的形式在不同的传输介质上进行传输
- 在实际的数据通信过程中，用户的数据在应用层以报文的形式开始向下一层进行封装，形成：段、数据报、帧，最后以比特流的形式进行传输
- 在中间结点处，例如路由器、交换机等，分别从对应的数据报、帧中取出并对相应的路由、地址信息进行处理
- 送达目的主机后由下层到上层开始逐层处理，并去掉相应的头部信息，最终还原为最初的报文

### 三、TCP/IP 与 OSI 的区别

两者都是按分层的思想对计算机网络进行模块化设计，区别包括：

1. 层侧划分不同：OSI 7，TCP/IP 4，两者都有网络层、传输层、应用层；后者没有表示层、会话层（合并至应用层），将物理层和数据链路层合并至网络接口层
2. 面向连接和面向无连接的通信不同：OSI 在网络层支持两种，在传输层仅支持面向连接；TCP/IP 在网络层仅支持面向无连接，在传输层支持两种
3. 与具体协议的配合程度：OSI 设计在具体协议前，有很好的通用性，但很多功能不知道放在那一层；TCP/IP 相反，所以对协议配合更好

## 第四节 TCP 和 UDP

TCP/IP 是 Internet 的基础框架，其中主要包含：
- 网络互联层的网络互连协议 IP
- 传输层的传输控制协议 TCP
- 用户数据报协议 UDP
- 应用层的域名系统 DNS
- 超文本传输协议 HTTP
- 文件传输协议 FTP

### 一、TCP/IP 中的传输层

传输层的主要功能：
- 为应用进程之间提供端到端的逻辑通信
- 通常还对收到的报文进行差错检测
- 某些传输层协议进行端到端的数据传输可控性控制
- 针对应用层实现复用与解复用(Multiplexing/ Demuliplexing）

TCP/IP 中规定了两种不同的传输层协议：
1. 面向连接的传输控制协议 TCP
2. 无连接的用户数据报协议 UDP

不同主机、系统上的应用进程间通信，必须用统一的寻址方法：传输层使用协议端口号 Protocol Port Number，简称端口 Port

Internet 中，一台拥有 IP 地址的主机可以提供许多服务：Web、FTP、邮件，这些服务使用不同的进程，但都使用同一个 IP

因而使用 IP 区分网络服务是不够的，需使用“IP 地址 + 端口号”

端口号是一个 16 位的二进制整数，根据端口号大小可分为：
- 熟知端口：0~1023，固定分配给一些服务，21 FTP、25 SMTP、80 HTTP、135 RPC
- 注册端口：1024~49151，为没有熟知端口号应用使用，须在 IANA 登记，以防重复
- 客户端口：49152~65535，客户进程选择暂时使用

传输层提供无连接与面向连接两类服务：
- 无连接服务是指数据传输之前无需与对端进行任何信息交换，即“握手”，直接构造数据分组，直接发送出去
- 面向连接服务是指在数据传输之前，需要交换一些控制信息，建立连接（逻辑连接），然后再传输数据，数据传输结束后还需要再拆除连接

Internet 网络提供无连接服务的传输层协议是 UDP，提供面向连接服务的传输层协议是 TCP

### 二、UDP

传输层无连接的用户数据报协议

是一个不可靠协议，非常适合对于速率要求高、而对精确度要求相对较低的网络应用，如各种多媒体实时业务，视频会议、视频点播和网络电话等

```
首部：源端口号、目的端口号、长度、检验和
 +
应用数据
```

使用端口号为不同的应用保留其各自的数据传输通道，从而支持同一时刻内多项应用同时发送和接收数据

应用可以使用静态、动态端口，首部使用两个字节存放端口号，范围：0~65535

**长度**指包括**首部**和**数据部分**在内的总字节数，首部的长度固定，所以主要被用来计算可变长度的数据部分（又称为数据负载）

**检验和**保证数据安全

工作机制主要包括：

1. 传送数据时就从应用抓取并尽快发送至网络
- 发送端速度受限于应用数据生成速度、计算机能力、传输带宽
- 接收端将每个消息段放在队列，应用依次从队列读取

2. 不需要维护连接状态
- 包括收发状态等
- 因此服务机可同时向多个客户机传输相同的消息

3. 数据报的首部很短
- 8 字节 相对于 TCP 20 字节，额外开销很小

4. 吞吐量不受拥塞控制算法的调节
- 只受应用软件生成数据的速率、传输带宽、源端和终端主机性能的限制

5. 使用最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表

6. 面向报文
- 发送方的 UDP 对应用程序交下来的报文，在添加首部后就向下交付给 IP 层
- 不拆分不合并，保留些报文边界，应用程序需要选择合适的报文大小

### 三、TCP

P77
